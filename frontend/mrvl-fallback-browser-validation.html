<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRVL Image Fallback Browser Validation Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        .test-case {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        .test-case.pass {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .test-case.fail {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .test-image {
            width: 64px;
            height: 64px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .fallback-svg {
            fill: #6b7280;
        }
        .question-mark {
            font-size: 20px;
            font-weight: bold;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">üñºÔ∏è MRVL Image Fallback Browser Validation</h1>
            <p class="text-lg text-gray-600">Testing question mark fallback implementations across all image types</p>
            <div class="mt-4 bg-blue-100 border border-blue-300 rounded-lg p-4">
                <p class="text-blue-800 font-medium">‚ú® All tests should show question mark (?) placeholders for broken images</p>
            </div>
        </div>

        <!-- Test Results Summary -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Test Results Summary</h2>
            <div class="grid grid-cols-4 gap-4 text-center">
                <div class="bg-blue-50 p-4 rounded">
                    <div class="text-2xl font-bold text-blue-600" id="total-tests">0</div>
                    <div class="text-sm text-blue-800">Total Tests</div>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <div class="text-2xl font-bold text-green-600" id="passed-tests">0</div>
                    <div class="text-sm text-green-800">Passed</div>
                </div>
                <div class="bg-red-50 p-4 rounded">
                    <div class="text-2xl font-bold text-red-600" id="failed-tests">0</div>
                    <div class="text-sm text-red-800">Failed</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded">
                    <div class="text-2xl font-bold text-yellow-600" id="coverage-percent">0%</div>
                    <div class="text-sm text-yellow-800">Coverage</div>
                </div>
            </div>
        </div>

        <!-- Test Cases -->
        <div class="test-grid" id="test-grid">
            <!-- Test cases will be generated by JavaScript -->
        </div>
    </div>

    <script>
        // Test configuration
        const testConfig = {
            baseUrl: window.location.origin,
            fallbackTypes: {
                'player-avatar': {
                    name: 'Player Avatar',
                    testUrls: [
                        'invalid-player-avatar.jpg',
                        'broken/player/avatar.png',
                        'https://nonexistent-domain.com/player.jpg'
                    ]
                },
                'team-logo': {
                    name: 'Team Logo',
                    testUrls: [
                        'invalid-team-logo.png',
                        'broken/team/logo.svg',
                        'https://nonexistent-domain.com/team.png'
                    ]
                },
                'event-banner': {
                    name: 'Event Banner',
                    testUrls: [
                        'invalid-event-banner.jpg',
                        'broken/event/banner.png',
                        'https://nonexistent-domain.com/event.jpg'
                    ]
                },
                'news-featured': {
                    name: 'News Featured Image',
                    testUrls: [
                        'invalid-news-image.jpg',
                        'broken/news/featured.png',
                        'https://nonexistent-domain.com/news.jpg'
                    ]
                },
                'general': {
                    name: 'General Image',
                    testUrls: [
                        'invalid-general-image.jpg',
                        'broken/general/image.png',
                        'https://nonexistent-domain.com/general.jpg'
                    ]
                }
            }
        };

        // Fallback SVG data URIs (from imageUtils.js)
        const fallbackDataURIs = {
            'player-avatar': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGM0Y0RjYiLz4KPHRleHQgeD0iMjAiIHk9IjI4IiBmb250LWZhbWlseT0ic3lzdGVtLXVpIiBmb250LXNpemU9IjIwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZCNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+',
            'team-logo': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGM0Y0RjYiLz4KPHRleHQgeD0iMjAiIHk9IjI4IiBmb250LWZhbWlseT0ic3lzdGVtLXVpIiBmb250LXNpemU9IjIwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZCNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+',
            'news-featured': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTEwIiBmb250LWZhbWlseT0ic3lzdGVtLXVpIiBmb250LXNpemU9IjQwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZCNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+',
            'event-banner': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDgwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9InRvdXJuYW1lbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZGMyNjI2O3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNiOTFjMWM7c3RvcC1vcGFjaXR5OjEiIC8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9InVybCgjdG91cm5hbWVudCkiLz4KPHN2ZyB4PSIzNzUiIHk9IjEyNSIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjgiPgo8cGF0aCBkPSJNMTIgMkw0IDdsOSA1IDkgLTUtOEwyWk0xMiAyMWwtOC01aDJsNiAyIDYtMmgyTDEyIDIxWiIvPgo8L3N2Zz4KPHR5cGUgeD0iNDAwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIG9wYWNpdHk9IjAuNyI+VE9VUk5BTUVOVCA8L3R5cGU+Cjwvc3ZnPg==',
            'general': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGM0Y0RjYiLz4KPHRleHQgeD0iMjAiIHk9IjI4IiBmb250LWZhbWlseT0ic3lzdGVtLXVpIiBmb250LXNpemU9IjIwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZCNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+PzwvdGV4dD4KPC9zdmc+'
        };

        // Test results
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // Check if an image contains a question mark
        function hasQuestionMark(imgElement) {
            return new Promise((resolve) => {
                if (imgElement.src.startsWith('data:image/svg+xml')) {
                    // For SVG data URIs, check if they contain the question mark
                    try {
                        const svgData = atob(imgElement.src.split(',')[1]);
                        resolve(svgData.includes('?'));
                    } catch (e) {
                        resolve(false);
                    }
                } else {
                    resolve(false);
                }
            });
        }

        // Test a single image fallback
        async function testImageFallback(fallbackType, testUrl, index) {
            return new Promise((resolve) => {
                const testId = `test-${fallbackType}-${index}`;
                
                // Create test case container
                const testCase = document.createElement('div');
                testCase.className = 'test-case';
                testCase.id = testId;
                
                // Create image element with onError handler
                const img = document.createElement('img');
                img.className = 'test-image';
                img.src = testUrl;
                
                let testPassed = false;
                let errorHandled = false;
                
                img.onError = function(e) {
                    errorHandled = true;
                    console.log(`üî• Image error triggered for ${fallbackType}: ${testUrl}`);
                    
                    // Simulate the actual fallback logic from imageUtils
                    if (fallbackDataURIs[fallbackType]) {
                        e.target.src = fallbackDataURIs[fallbackType];
                    } else {
                        e.target.src = fallbackDataURIs['general'];
                    }
                };
                
                img.onLoad = async function() {
                    if (errorHandled) {
                        // Check if the loaded image is the fallback with question mark
                        const hasQuestionMarkResult = await hasQuestionMark(img);
                        testPassed = hasQuestionMarkResult;
                        
                        // Update test case appearance
                        testCase.className = testPassed ? 'test-case pass' : 'test-case fail';
                        
                        // Update results
                        if (testPassed) {
                            testResults.passed++;
                        } else {
                            testResults.failed++;
                        }
                        
                        updateSummary();
                    }
                    
                    resolve(testPassed);
                };
                
                // Build test case HTML
                testCase.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-900">${testConfig.fallbackTypes[fallbackType].name}</h3>
                        <div class="text-sm ${testPassed ? 'text-green-600' : 'text-red-600'}">
                            ${testPassed ? '‚úÖ PASS' : '‚ùå FAIL'}
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mb-2">
                        Testing: <code>${testUrl}</code>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0"></div>
                        <div class="text-sm text-gray-700">
                            Expected: Question mark (?) placeholder<br>
                            Status: <span class="${testPassed ? 'text-green-600' : 'text-red-600'}">
                                ${errorHandled ? (testPassed ? 'Fallback loaded correctly' : 'Fallback incorrect') : 'Waiting...'}
                            </span>
                        </div>
                    </div>
                `;
                
                // Add image to test case
                testCase.querySelector('.flex-shrink-0').appendChild(img);
                
                // Add to DOM
                document.getElementById('test-grid').appendChild(testCase);
                testResults.total++;
                updateSummary();
                
                // Set timeout to fail test if no error occurs
                setTimeout(() => {
                    if (!errorHandled) {
                        console.warn(`‚ö†Ô∏è Test timeout: Image may have loaded successfully (not testing fallback): ${testUrl}`);
                        testCase.className = 'test-case fail';
                        testResults.failed++;
                        updateSummary();
                        resolve(false);
                    }
                }, 5000);
            });
        }

        // Update summary display
        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            
            const coverage = testResults.total > 0 
                ? Math.round((testResults.passed / testResults.total) * 100)
                : 0;
            document.getElementById('coverage-percent').textContent = coverage + '%';
        }

        // Run all tests
        async function runAllTests() {
            console.log('üöÄ Starting MRVL Image Fallback Browser Validation Tests');
            
            // Test each fallback type
            for (const [fallbackType, config] of Object.entries(testConfig.fallbackTypes)) {
                console.log(`Testing ${config.name} fallbacks...`);
                
                for (let i = 0; i < config.testUrls.length; i++) {
                    await testImageFallback(fallbackType, config.testUrls[i], i);
                    // Add small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log('‚úÖ All tests completed!');
            console.log(`üìä Results: ${testResults.passed}/${testResults.total} tests passed`);
            
            // Generate final report
            generateFinalReport();
        }

        // Generate final report
        function generateFinalReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    coverage: Math.round((testResults.passed / testResults.total) * 100)
                },
                testsByType: {}
            };
            
            // Group results by type
            for (const [fallbackType, config] of Object.entries(testConfig.fallbackTypes)) {
                const typeTests = config.testUrls.length;
                reportData.testsByType[fallbackType] = {
                    name: config.name,
                    total: typeTests,
                    // In a real implementation, we'd track individual results
                };
            }
            
            console.log('üìÑ Browser Test Report:', reportData);
            
            // Store results in localStorage for later retrieval
            localStorage.setItem('mrvl-fallback-test-results', JSON.stringify(reportData));
        }

        // Additional test for live components
        function testLiveComponentFallbacks() {
            console.log('üîç Testing live components on current page...');
            
            const allImages = document.querySelectorAll('img');
            let liveTestResults = {
                total: allImages.length,
                withOnError: 0,
                withoutOnError: 0
            };
            
            allImages.forEach((img, index) => {
                const hasOnErrorHandler = img.hasAttribute('onerror') || 
                                        (img.onError && img.onError.toString() !== 'function onError() { [native code] }');
                
                if (hasOnErrorHandler) {
                    liveTestResults.withOnError++;
                } else {
                    liveTestResults.withoutOnError++;
                }
            });
            
            console.log('üìä Live Component Results:', liveTestResults);
            return liveTestResults;
        }

        // Start tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runAllTests, 1000);
            
            // Also test any existing images on the page
            setTimeout(testLiveComponentFallbacks, 2000);
        });

        // Export results for external access
        window.MRVLFallbackTest = {
            results: () => testResults,
            runTests: runAllTests,
            testLiveComponents: testLiveComponentFallbacks
        };
    </script>
</body>
</html>